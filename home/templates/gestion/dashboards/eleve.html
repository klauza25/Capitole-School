{% extends "gestion/base.html" %}
{% load static %}

{% block title %}Dashboard √âl√®ve - Capitole School{% endblock %}

{% block nav_links %}
<li class="nav-item"><a class="nav-link active" href="#">Tableau de bord</a></li>
<li class="nav-item"><a class="nav-link" href="#">Mes notes</a></li>
<li class="nav-item"><a class="nav-link" href="#">Emploi du temps</a></li>
<li class="nav-item"><a class="nav-link" href="#">Messages</a></li>
<li class="nav-item"><a class="nav-link" href="{% url 'home:logout' %}">D√©connexion</a></li>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- Sidebar Fixe -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse bg-dark text-white" id="sidebarMenu">
            <div class="position-sticky vh-100 py-3" style="overflow-y: auto;">
                <h5 class="px-3 mb-3 text-white">√âl√®ve</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="#">
                            <i class="fas fa-home me-2"></i> Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">
                            <i class="fas fa-clipboard me-2"></i> Notes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">
                            <i class="fas fa-calendar-alt me-2"></i> Emploi du temps
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">
                            <i class="fas fa-user me-2"></i> Profil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#">
                            <i class="fas fa-comment me-2"></i> Messages
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="{% url 'home:logout' %}">
                            <i class="fas fa-sign-out-alt me-2"></i> D√©connexion
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" style="height: calc(100vh - 56px); overflow-y: auto;">
            <!-- Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2 text-white">Bonjour, <strong>{{ user.role|title }}</strong> - {{ user.first_name }} {{ user.last_name }}</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-light" id="printButton">
                        <i class="fas fa-print me-1"></i> Imprimer
                    </button>
                </div>
            </div>

            <!-- Profil rapide -->
            <div class="card mb-4 bg-dark shadow">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <!-- Affichage de la photo -->
                        {% if user.photo %}
                            <img src="{{ user.photo.url }}" class="rounded-circle me-4" style="width: 80px; height: 80px; object-fit: cover;" id="currentPhoto">
                        {% else %}
                            <div class="avatar-large bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-4" style="width: 80px; height: 80px; font-size: 2rem; font-weight: bold;" id="currentPhoto">
                                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                            </div>
                        {% endif %}

                        <!-- Informations utilisateur -->
                        <div class="flex-grow-1">
                            <h3 class="text-white">{{ user.first_name }} {{ user.last_name }}</h3>
                            <p class="text-muted mb-1">
                                <strong>Matricule :</strong> {{ eleve.matricule }} |
                                <strong>Genre :</strong> {{ eleve.get_genre_display }}
                            </p>
                            <p class="text-muted mb-1">
                                <strong>Classe :</strong>
                                {% if eleve.classe_actuelle %}
                                    {{ eleve.classe_actuelle }}
                                {% else %}
                                    <span class="text-danger">Non assign√©</span>
                                {% endif %}
                            </p>
                            <p class="text-muted">
                                <strong>Niveau :</strong>
                                {% if eleve.classe_actuelle and eleve.classe_actuelle.niveau %}
                                    {{ eleve.classe_actuelle.niveau }}
                                    {% if eleve.classe_actuelle.niveau.cycle %}
                                        ({{ eleve.classe_actuelle.niveau.cycle }})
                                    {% endif %}
                                {% else %}
                                    Non d√©fini
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Bouton pour changer la photo -->
                    <div class="mt-3 pt-3 border-top border-secondary">
                        <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('photoUpload').click()">
                            üì∑ Changer la photo
                        </button>
                        <form id="photoForm" method="post" enctype="multipart/form-data" style="display: none;">
                            {% csrf_token %}
                            <input type="file"
                                   id="photoUpload"
                                   name="photo"
                                   accept="image/*"
                                   onchange="this.form.submit()">
                        </form>
                    </div>
                </div>
            </div>

            <!-- Statistiques -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ notes.count }}</h5>
                            <p class="card-text small">Notes</p>
                            <i class="fas fa-clipboard fa-2x opacity-50 ms-auto"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ taux_presence }}%</h5>
                            <p class="card-text small">Pr√©sence</p>
                            <i class="fas fa-check-circle fa-2x opacity-50 ms-auto"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning text-dark shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ absences_count }}</h5>
                            <p class="card-text small">Absences</p>
                            <i class="fas fa-times-circle fa-2x opacity-50 ms-auto"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">1</h5>
                            <p class="card-text small">Retard</p>
                            <i class="fas fa-clock fa-2x opacity-50 ms-auto"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes par trimestre -->
            {% for trimestre_data in trimestres %}
                <div class="card mb-4 bg-dark shadow">
                    <div class="card-header bg-gradient-primary d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clipboard me-2"></i>
                            <h5 class="mb-0">Mes notes - {{ trimestre_data.nom }}</h5>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2">Moyenne :</span>
                            <span class="badge bg-info text-dark fs-5">
                                {{ trimestre_data.moyenne|floatformat:2 }}/20
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead class="table-secondary">
                                    <tr>
                                        <th><i class="fas fa-book me-1"></i> Mati√®re</th>
                                        <th><i class="fas fa-sort-numeric-down me-1"></i> Devoir 1</th>
                                        <th><i class="fas fa-sort-numeric-down me-1"></i> Devoir 2</th>
                                        <th><i class="fas fa-sort-numeric-down me-1"></i> Devoir 3</th>
                                        <th><i class="fas fa-sort-numeric-down me-1"></i> Composition</th>
                                        <th><i class="fas fa-sort-numeric-down me-1"></i> D√©part.</th>
                                        <th><i class="fas fa-calculator me-1"></i> Moyenne</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for matiere_data in trimestre_data.matieres %}
                                    <tr class="align-middle">
                                        <td class="fw-bold">{{ matiere_data.matiere.nom }}</td>
                                        <td>
                                            {% if matiere_data.devoir1 %}
                                                <span class="badge {% if matiere_data.devoir1.valeur >= 15 %}bg-success{% elif matiere_data.devoir1.valeur >= 10 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ matiere_data.devoir1.valeur|floatformat:1 }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if matiere_data.devoir2 %}
                                                <span class="badge {% if matiere_data.devoir2.valeur >= 15 %}bg-success{% elif matiere_data.devoir2.valeur >= 10 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ matiere_data.devoir2.valeur|floatformat:1 }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if matiere_data.devoir3 %}
                                                <span class="badge {% if matiere_data.devoir3.valeur >= 15 %}bg-success{% elif matiere_data.devoir3.valeur >= 10 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ matiere_data.devoir3.valeur|floatformat:1 }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if matiere_data.composition %}
                                                <span class="badge {% if matiere_data.composition.valeur >= 15 %}bg-success{% elif matiere_data.composition.valeur >= 10 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ matiere_data.composition.valeur|floatformat:1 }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if matiere_data.departemental %}
                                                <span class="badge {% if matiere_data.departemental.valeur >= 15 %}bg-success{% elif matiere_data.departemental.valeur >= 10 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                    {{ matiere_data.departemental.valeur|floatformat:1 }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary fs-5">
                                                {{ matiere_data.moyenne|floatformat:2 }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-secondary fw-bold">
                                        <td colspan="6" class="text-end">MOYENNE G√âN√âRALE</td>
                                        <td>
                                            <span class="badge bg-info text-dark fs-5">
                                                {{ trimestre_data.moyenne|floatformat:2 }}/20
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}

            <!-- Pr√©sences r√©centes -->
            <div class="card mb-4 bg-dark shadow">
                <div class="card-header bg-gradient-success d-flex align-items-center">
                    <i class="fas fa-calendar-check me-2"></i>
                    <h5 class="mb-0">Pr√©sences r√©centes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="table-secondary">
                                <tr>
                                    <th><i class="fas fa-calendar me-1"></i> Date</th>
                                    <th><i class="fas fa-user-check me-1"></i> Statut</th>
                                    <th><i class="fas fa-comment me-1"></i> Justification</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for presence in presences %}
                                <tr class="align-middle">
                                    <td>{{ presence.date|date:"d M Y" }}</td>
                                    <td>
                                        <span class="badge {% if presence.present %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ presence.get_present_display }}
                                        </span>
                                    </td>
                                    <td>{{ presence.justification|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-alt me-2"></i> Aucune pr√©sence enregistr√©e
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Informations m√©dicales -->
            {% if eleve.infos_medicaux %}
            <div class="card mb-4 bg-dark shadow">
                <div class="card-header bg-gradient-warning d-flex align-items-center">
                    <i class="fas fa-heartbeat me-2"></i>
                    <h5 class="mb-0">Informations m√©dicales</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ eleve.infos_medicaux }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Espace pour tester le scroll -->
            <div style="height: 400px;"></div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Active menu item
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function() {
            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Ferme la sidebar sur mobile apr√®s clic
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebarMenu');
                sidebar.classList.remove('show');
            }
        });
    });
    
    // Gestion de l'impression
    document.getElementById('printButton').addEventListener('click', function() {
        window.print();
    });
    
    // Script pour pr√©visualiser l'image apr√®s s√©lection
    document.getElementById('photoUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Met √† jour l'image affich√©e
                const currentPhoto = document.getElementById('currentPhoto');
                if (currentPhoto.tagName === 'IMG') {
                    currentPhoto.src = e.target.result;
                } else {
                    currentPhoto.innerHTML = '<img src="' + e.target.result + '" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%;">';
                }
            };
            reader.readAsDataURL(file);
        }
    });
</script>
{% endblock %}